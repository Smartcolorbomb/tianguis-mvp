<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tianguis Cerca de MÃ­</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #map { height: 50vh; width: 100%; }
    #list { padding: 1em; }
    .tianguis { margin-bottom: 1em; padding: 1em; border: 1px solid #ccc; border-radius: 5px; }
    .highlight { background-color: #eef; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDndz38d9S7_VStKc_ZZvj1LcL8NEdM1j8"></script>
</head>
<body>
  <h2 style="text-align:center">ğŸ§º Tianguis Cerca de MÃ­</h2>
  <div id="map"></div>
  <div id="list"></div>

  <script>
    const today = new Date().toLocaleDateString('en-US', { weekday: 'long' });
    const tianguisData = [
      {
        id: "etla",
        name: "Tianguis de Etla",
        lat: 17.1725,
        lng: -96.7833,
        day: "Wednesday",
        hours: "07:00â€“14:00",
        products: ["Queso", "Verduras", "Flores"]
      },
      {
        id: "tlacolula",
        name: "Tlacolula",
        lat: 16.9508,
        lng: -96.4806,
        day: "Sunday",
        hours: "06:00â€“16:00",
        products: ["Mezcal", "Textiles", "Comida"]
      }
    ];

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function init() {
      if (!window.google || !window.google.maps) {
        alert("Google Maps API no cargado correctamente.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const userLat = pos.coords.latitude;
          const userLng = pos.coords.longitude;

          const map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: userLat, lng: userLng },
            zoom: 10
          });

          new google.maps.Marker({
            position: { lat: userLat, lng: userLng },
            map,
            title: "TÃº estÃ¡s aquÃ­",
            icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
          });

          const listDiv = document.getElementById("list");

          const tianguisWithDistance = tianguisData.map(t => {
            const dist = haversineDistance(userLat, userLng, t.lat, t.lng);
            return { ...t, distance: dist };
          }).sort((a, b) => a.distance - b.distance);

          tianguisWithDistance.forEach(t => {
            new google.maps.Marker({
              position: { lat: t.lat, lng: t.lng },
              map,
              title: t.name,
              icon: t.day === today ? 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' : null
            });

            const div = document.createElement('div');
            div.className = 'tianguis' + (t.day === today ? ' highlight' : '');
            div.innerHTML = `<strong>${t.name}</strong><br>
                             ğŸ“ ${t.distance.toFixed(1)} km<br>
                             ğŸ—“ï¸ ${t.day} â€“ ${t.hours}<br>
                             ğŸ§º ${t.products.join(", ")}`;
            listDiv.appendChild(div);
          });
        },
        err => alert("No pudimos obtener tu ubicaciÃ³n")
      );
    }

    window.onload = init;
  </script>
</body>
</html>
